{% extends "layout.html" %}

{% block title %}ZXZ{% endblock %}

{% block content %}
{% set fhost_url = url_for("fhost", _external=True).rstrip("/") %}
<div class="col-md-12 mb-4">
    <h2>THE FIRST REGISTER</h2>
    <div class="row">
        <div class="col-md-12 indented-content">
            <ul>
                <li>HTTP POST files here:</li>
                <pre><code>curl -F'file=@yourfile.png' {{ fhost_url }}</code></pre>
                <li>You can also POST remote URLs:</li>
                <pre><code>curl -F'url=http://example.com/image.jpg' {{ fhost_url }}</code></pre>
                <li>If you don't want the resulting URL to be easy to guess:</li>
                <pre><code>curl -F'file=@yourfile.png' -Fsecret= {{ fhost_url }}</code>
<code>curl -F'url=http://example.com/image.jpg' -Fsecret= {{ fhost_url }}</code></pre>
                <li>Or you can shorten URLs:</li>
                <pre><code>curl -F'shorten=http://example.com/some/long/url' {{ fhost_url }}</code></pre>
                <li>It is possible to append your own file name to the URL:</li>
                <pre><code>{{ fhost_url }}/aaa.jpg/image.jpeg</code></pre>
            </ul>
            <p><b>File URLs are valid for at least 30 days and up to a year (see below).</b></p>
            <ul>
                <li>Files can be set to expire sooner by adding an "expires" parameter (in hours)</li>
                <pre><code>curl -F'file=@yourfile.png' -Fexpires=24 http://192.168.120.107:5000</code></pre>
                <li>OR by setting "expires" to a timestamp in epoch milliseconds</li>
                <pre><code>curl -F'file=@yourfile.png' -Fexpires=1681996320000 http://192.168.120.107:5000</code></pre>
            </ul>

            <p>Expired files won't be removed immediately, but will be removed as part of the next purge.
            <p>
            <p>Whenever a file that does not already exist or has expired is uploaded, the HTTP response header includes
                an X-Token field. You can use this to perform management operations on the file.
            <p>

            <ul>
                <li>To delete the file immediately:</li>
                <pre><code>curl -Ftoken=token_here -Fdelete= {{ fhost_url }}/abc.txt</code></pre>
                <li>To change the expiration date (see above):</li>
                <pre><code>curl -Ftoken=token_here -Fexpires=3 {{ fhost_url }}/abc.txt</code></pre>
            </ul>

            {% set max_size = config["MAX_CONTENT_LENGTH"]|filesizeformat(True) %}
            <p>Maximum file size: <b>{{ max_size }}</b></p>
            <p>Not allowed:
                {% for item in config["FHOST_MIME_BLACKLIST"] %}
                <code>{{ item }}</code>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
        </div>
    </div>
</div>
<div class="col-md-12 mb-4">
    <h2>TERMS OF SERVICE</h2>
    <div class="row">
        <div class="col-md-12 indented-content">
            <ul>
                <li><code>{{ fhost_url }}</code> is NOT a platform for:</li>
                <ul>
                    <li>piracy</li>
                    <li>pornography and gore</li>
                    <li>extremist material of any kind</li>
                    <li>malware / botnet C&C</li>
                    <li>anything related to crypto currencies</li>
                    <li>backups (yes, this includes your minecraft stuff, seriously people have been dumping terabytes
                        of it here for years)</li>
                    <li>CI build artifacts</li>
                    <li>doxxing, database dumps containing personal information</li>
                    <li>anything illegal under Australian law</li>
                </ul>
            </ul>
            <p>Uploads found to be in violation of these rules will be removed, and the originating IP address blocked
                from further uploads.</p>
        </div>
    </div>
</div>
<div class="col-md-12 mb-4">
    <h2>WEB UPLOAD</h2>
    <div class="row">
        <div class="col-md-12 indented-content">
            <form id="fileUploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="file" class="form-label">Choose File</label>
                    <input type="file" class="form-control" id="file" name="file" onchange="clearResponseText('response')">
                </div>
                <div class="mb-3">
                    <input type="checkbox" id="enableSecret" onchange="toggleSecret()">
                    <label for="secret" class="form-label">Secret</label>
                    <input type="hidden" class="form-control" id="secret" name="secret" disabled>
                </div>
                <div class="mb-3">
                    <input type="checkbox" id="enableExpiration" onchange="toggleExpiration()">
                    <label for="datetimepicker" class="form-label">Select Date and Time</label>
                    <input type="datetime-local" class="form-control" id="datetimepicker" name="datetimepicker" disabled>
                    <input type="hidden" class="form-control" id="expires" name="expires" disabled>
                </div>
                <button type="button" class="btn btn-primary" onclick="submitForm()">Submit</button>
            </form>
            <div id="response" class="mt-3" style="display: none;"></div>
        </div>
    </div>
</div>
<div class="col-md-12 mb-4">
    <h2>SHORTEN URL</h2>
    <div class="row">
        <div class="col-md-12 indented-content">
            <form id="shortenUrlForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="shorten" class="form-label">URL</label>
                    <input type="text" class="form-control" id="shorten" name="shorten">
                </div>
                <button type="button" class="btn btn-primary" onclick="submitShortenUrl()">Submit</button>
            </form>
            <div id="responseShortenUrl" class="mt-3" style="display: none;"></div>
        </div>
    </div>
</div>
<div class="col-md-12 mb-4">
    <h2>OPERATOR NOTES</h2>
    <div class="row">
        <div class="col-md-12 indented-content">
            <p>If you run a server and like this site, clone it! Centralization is bad.</p>
            <a href="https://git.0x0.st/mia/0x0">https://git.0x0.st/mia/0x0</a>
            <p>Hosting costs about 60 EUR a month.</p>
            <p>You can also support Original author Mia financially via libreapay.</p>
            <div class="col-md-12" style="margin-bottom: 20px;">
                <a href="https://liberapay.com/mia/donate">
                    <img src="https://img.shields.io/liberapay/receives/mia.svg?logo=liberapay">
                </a>
            </div>
            <p>If you wish to make just a small one-time donation, that is cool too!</p>
            <p>It will go towards my coffee habits.</p>
        </div>
    </div>
</div>
<div class="col-md-12 mb-4">
    <h2>FILE RETENTION PERIOD</h2>
    <div class="row">
        <div class="col-md-12 indented-content">
            <p><code>retention = min_age + (-max_age + min_age) * pow((file_size / max_size - 1), 3)</code></p>
            <!-- Render plot -->
            <canvas id="retentionChart"></canvas>
        </div>
    </div>
</div>
<!-- Bootstrap Chart JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0"></script>
<!-- Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>

<script>
    // Function to convert date to timestamp in milliseconds
    function datetimeToTimestamp(dateString) {
        var date = new Date(dateString);
        return date.getTime();
    }

    var min_age = {{'{: 6}'.format(config.get("FHOST_MIN_EXPIRATION", 2592000000)/86400000)}};
    var max_age = {{'{: 6}'.format(config.get("FHOST_MAX_EXPIRATION", 2592000000)/86400000)}};
    var max_size = {{'{: 6}'.format(config["MAX_CONTENT_LENGTH"] / 1024 / 1024)}};

    function calculate_retention(file_size, min_age, max_age, max_size) {
        return min_age + (-max_age + min_age) * Math.pow((file_size / max_size - 1), 3);
    }

    var data_x = [];
    var data_y = [];
    for (let i = 0; i <= 512; i += 1) {
        data_x.push(i);
        data_y.push(calculate_retention(i, min_age, max_age, max_size));
    }

    var retentionChart = new Chart(document.getElementById('retentionChart'), {
        type: 'line',
        data: {
            labels: data_x,
            datasets: [{
                label: 'Retention',
                data: data_y,
                borderColor: '#d882d2',
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'File Size (MB)'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Retention (Days)'
                    },
                    suggestedMin: 0
                }
            }
        }
    });

    function toggleSecret() {
        var secretInput = document.getElementById("secret");
        var enableSecretCheckbox = document.getElementById("enableSecret");
        secretInput.disabled = !enableSecretCheckbox.checked;
    }

    function toggleExpiration() {
        var expiresInput = document.getElementById('expires');
        var datetimeInput = document.getElementById('datetimepicker');
        var enableExpirationCheckbox = document.getElementById("enableExpiration");
        expiresInput.disabled = !enableExpirationCheckbox.checked;
        datetimeInput.disabled = !enableExpirationCheckbox.checked;
    }

    function submitForm() {
        clearResponseText('response');
        var fileInput = document.getElementById("file");
        var file = fileInput.files[0];
        var secretInput = document.getElementById("secret");
        var secret = secretInput.value;

        var expiresInput = document.getElementById('expires');
        var datetimeInput = document.getElementById('datetimepicker');
        var selectedDatetime = datetimeInput.value;
        var timestamp = datetimeToTimestamp(selectedDatetime);
        expiresInput.value = timestamp;

        var form = document.getElementById("fileUploadForm");
        var formData = new FormData(form);
      
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    showResponse(xhr.responseText.trim(), xhr.status, 'response');
                } else if (xhr.status === 400) {
                    showResponse("400 Bad request", xhr.status, 'response');
                } else if (xhr.status === 401) {
                    showResponse("401 Unauthorized", xhr.status, 'response');
                } else if (xhr.status === 404) {
                    showResponse("404 Not Found", xhr.status, 'response');
                } else if (xhr.status === 411) {
                    showResponse("411 Length Required", xhr.status, 'response');
                } else if (xhr.status === 413) {
                    showResponse("413 Payload Too Large", xhr.status, 'response');
                } else if (xhr.status === 451) {
                    showResponse("451 Unavailable For Legal Reasons", xhr.status, 'response');
                } else {
                    showResponse("ERROR " + xhr.status, xhr.status, 'response');
                }
            }
        };
        xhr.send(formData);
    }
    
    function submitShortenUrl() {
        clearResponseText('responseShortenUrl');
        var form = document.getElementById("shortenUrlForm");
        var formData = new FormData(form);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    showResponse(xhr.responseText.trim(), xhr.status, 'responseShortenUrl');
                } else if (xhr.status === 400) {
                    showResponse("400 Bad request", xhr.status, 'responseShortenUrl');
                } else if (xhr.status === 401) {
                    showResponse("401 Unauthorized", xhr.status, 'responseShortenUrl');
                } else if (xhr.status === 404) {
                    showResponse("404 Not Found", xhr.status, 'responseShortenUrl');
                } else if (xhr.status === 411) {
                    showResponse("411 Length Required", xhr.status, 'responseShortenUrl');
                } else if (xhr.status === 413) {
                    showResponse("413 Payload Too Large", xhr.status, 'responseShortenUrl');
                } else if (xhr.status === 451) {
                    showResponse("451 Unavailable For Legal Reasons", xhr.status, 'responseShortenUrl');
                } else {
                    showResponse("ERROR " + xhr.status, xhr.status, 'responseShortenUrl');
                }
            }
        };
        xhr.send(formData);
    }

    function clearResponseText(responseElement) {
        var responseDiv = document.getElementById(responseElement);
        responseDiv.style.display = "none";
        responseDiv.textContent = ""; // Clear the response text
        responseDiv.className = "";
    }
    
    function showResponse(text, statusCode, responseElement) {
        // Request successful
        var responseDiv = document.getElementById(responseElement);
        responseDiv.style.display = "block";
        var codeElement = document.createElement('code');
        // Set its text content to the trimmed response
        codeElement.textContent = text
        codeElement.className = "response-code";// + responseElement;
        responseDiv.appendChild(codeElement);
        responseDiv.role = "alert";
        if (statusCode === 200) {
            responseDiv.className = "mt-3 alert alert-success";
            codeElement.style.color = "#1c8556";
            addCopyButton(text, responseElement);
        } else {
            responseDiv.className = "mt-3 alert alert-danger";
            codeElement.style.color = "#dc3545";
        }
    }
    // Function to add a copy button
    function addCopyButton(text, responseElement) {
        var button = document.createElement("button");
        button.className = "btn btn-success ms-2";
        //button.id = 
        button.textContent = 'Copy';
        button.onclick = function () {copyToClipboard(text);};
        var responseDiv = document.getElementById(responseElement);
        responseDiv.appendChild(button);
        // Center the button horizontally
    }

    // Function to copy text to clipboard
    function copyToClipboard(text) {
        var textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        alert("Copied to clipboard: " + text);
    }
</script>
{% endblock %}